<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('root') }}">Почтовый менеджер</a>
        <div class="dropdown">
            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton1"
                    data-toggle="dropdown"
                    aria-expanded="false">
                Прогресс получения почты
            </button>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton1" style="width: 250px;">
                <table class="table table-sm" id="accountProgressContainer">
                    <thead>
                    <tr>
                        <th>Аккаунт</th>
                        <th>Прогресс</th>
                        <th>Статус</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr id="noDataRow">
                        <td colspan="3" class="text-center">Нет данных</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</nav>
<script>
    let globalWebSocket;
    let activeAccounts = new Set();

    function connectWebSocket() {
        if (globalWebSocket) {
            globalWebSocket.close();
        }

        globalWebSocket = new WebSocket(`ws://${window.location.host}/ws/progress`);

        globalWebSocket.onopen = function(event) {
            console.log("WebSocket connection established");
        };

        globalWebSocket.onmessage = function(event) {
            try {
                var data = JSON.parse(event.data);
                if (data.type === 'send_progress') {
                    updateProgressBar(data.account_id, data.progress, data.account_name);
                } else if (data.type === 'fetch_status') {
                    updateFetchStatus(data.account_id, data.status, data.message);
                }
            } catch (error) {
                console.error("Error processing WebSocket message:", error);
            }
        };

        globalWebSocket.onerror = function(event) {
            console.error("WebSocket error observed:", event);
        };

        globalWebSocket.onclose = function(event) {
            console.log("WebSocket connection closed");
            setTimeout(connectWebSocket, 5000);
        };
    }

    function updateProgressBar(accountId, progress, accountName) {
        let progressContainer = document.getElementById(`progress-${accountId}`);
        if (!progressContainer) {
            progressContainer = createProgressBar(accountId, accountName);
        }

        let progressBar = progressContainer.querySelector('.progress-bar');
        let progressText = progressContainer.querySelector('.progress-text');

        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressText.textContent = `${progress}%`;

        if (progress >= 100) {
            setTimeout(() => {
                progressContainer.remove();
                activeAccounts.delete(accountId);
                checkNoData();
            }, 3000);
        }

        checkNoData();
    }

    function createProgressBar(accountId, accountName) {
        let container = document.createElement('tr');
        container.id = `progress-${accountId}`;
        container.innerHTML = `
            <td>${accountName}</td>
            <td>
                <div class="progress">
                    <div class="progress-bar progress-text" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
            </td>
            <td id="status-${accountId}"></td>
        `;
        document.getElementById('accountProgressContainer').querySelector('tbody').appendChild(container);
        return container;
    }

    function updateFetchStatus(accountId, status, message) {
        if (status === 'started') {
            activeAccounts.add(accountId);
        } else if (status === 'completed' || status === 'error') {
            activeAccounts.delete(accountId);
        }

        let statusCell = document.getElementById(`status-${accountId}`);
        if (!statusCell) {
            let progressRow = createProgressBar(accountId, '');
            statusCell = progressRow.querySelector(`#status-${accountId}`);
        }

        statusCell.innerHTML = `
            <div class="alert mb-0 p-1 ${status === 'error' ? 'alert-danger' : 'alert-info'}">${message}</div>
        `;

        if (status === 'completed' || status === 'error') {
            setTimeout(() => {
                let progressRow = statusCell.closest('tr');
                if (progressRow) {
                    progressRow.remove();
                }
                checkNoData();
            }, 5000);
        }

        checkNoData();
    }

    function checkNoData() {
        let noDataRow = document.getElementById('noDataRow');
        let progressRows = document.querySelectorAll('[id^="progress-"]');

        if (progressRows.length === 0) {
            if (!noDataRow) {
                noDataRow = document.createElement('tr');
                noDataRow.id = 'noDataRow';
                noDataRow.innerHTML = '<td colspan="3" class="text-center">Нет данных</td>';
                document.getElementById('accountProgressContainer').querySelector('tbody').appendChild(noDataRow);
            }
        } else {
            if (noDataRow) {
                noDataRow.remove();
            }
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        checkNoData();
    });
    </script>